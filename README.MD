# Инфраструктура

В папке server - находится билд сервер  
В папке build - находится билд агент

- Очередь билдов проверяется с интервалом в 30 секунд. При наличии билдов в очереди, они отправляются на сборку агентам (можно еще добавить функционал - "проверять очередь и ставить на сборку при добавлении нового агента или окончании работы агента над билдом", но на это не хватило времени).
- По завершении работы агента, мы регистрируем, что агент свободен, и при наличии билдов в очереди мы можем отправлять ему билд на сборку
- Агент при ошибки клонирования репозитория или чекаута отправляет на сервер лог с сообщением ошибки и статус failed
- Агент останавливается если при старте не смог соединиться с сервером, по этой причине **ВАЖНО сперва запускать билд сервер**, а потом агент.
- Агент имеет 4 попытки успешно отправить информацию на сервер при помощи библиотеки axios-retry.

Для (частичной) безопасности хостовой системы билд агент упакован в docker образ. Для удобства запуска образ залит на docker hub

**Docker и все его команды запускались на Ubuntu 18.04.4 LTS. Может возникнуть проблема с --network="host" на других ОС.**

Самый простой способ запустить образ агента:

```
sudo docker run --network="host" -e PORT="5201" -e SERVER_HOST=127.0.0.1 -e SERVER_PORT="5100" mgkov/build-agent-shri2020
```

где

- PORT - это порт агента
- SERVER_PORT - порт сервера
- SERVER_HOST - хост сервера
- Можно еще указать github token (-e GH_TOKEN="...") но это не обязательно.

Также в папке agent есть Dockerfile, поэтому можно запустить свою сборку образа.

Для запуска через npm в папки server и agent необходимо добавить файлы с настройками:  
agent-conf.json

```
{
  "port": порт агента,
  "serverHost": хост сервера,
  "serverPort": порт сервера,
  "ghToken": гитхаб токен (необязательный параметр)
}

```

server-conf.json

```
{
  "port": порт сервера,
  "apiBaseUrl": "https://hw.shri.yandex/api/",
  "apiToken": токен для ШРИ api
}




# Тесты

Для тестирование сервера применялись модульные тесты.
Использовались следующие библиотеки:

- supertest
- jest

Модульными тестами проверялись ответы и часть сайд эффектов ручек апи.
Также проверялись некоторые мидллвары и вспомогательные функции.

Для клиентской части использовались интеграционные тесты.
Использовались следующие библиотеки:

- hermione
- selenium

К сожалению, не на все пользовательские сценарии успел покрыть интеграционные тестами.

Для тестов использовались api заглушки.

- shri-api-stub - для интеграционных тестов
- shri-api-test - для модульных тестов

В hri-api-stub написан не очень элегантный, но рабочий костыль для восстановления данных сервера при тестировании.

## Модульные тесты

Для запуска необходимо добавить в папку /config файл с наименованием test.js, следующего содержания:

```

{
"jwt": // токен от шри api,
"port": 5000, // Обязательно 5000
"github-token": // не обязательно, но github без токена позволяет делать только 60 запросов в час
}

```

Запуск тестов

```

npm run test

```

### Интеграционные тесты

Для запуска необходимо добавить в папку /config файл с наименованием stub.js, следующего содержания:

```

{
"jwt": // токен от шри api,
"port": 5000, // Обязательно 5000
"github-token": // не обязательно, но github без токена позволяет делать только 60 запросов в час
}

```

Запуск тестов
Сеты тестов (для разных браузеров) обязательно запускать раздельно, т.к. изменяются данные на stub сервере. По этой причине могут прийти неверные данные в браузер, запущенный паралельно.

```

selenium-standalone start

npm run server:stub

npm run hermione -- --set firefox
npm run hermione -- --set chrome

```

## Версия Node.js

"node": "^12.13.0"
"npm": "^6.12"

Для запуска необходимо добавить в папку /config файл с наименованием local.js, следующего содержания:

```

{
"jwt": // токен от шри api,
"port": 5000, // Обязательно 5000
"github-token": // не обязательно, но github без токена позволяет делать только 60 запросов в час
}

```

## запуск

```

npm start

```

```
